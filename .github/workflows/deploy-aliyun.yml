name: Deploy to Aliyun

on:
  push:
    branches:
      - main
    paths:
      - 'apps/**'
      - 'packages/**'
      - 'pnpm-lock.yaml'

  workflow_dispatch:
    inputs:
      deploy_target:
        description: '选择部署目标'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - admin-ele
          - web-nuxt

env:
  CI: true
  TZ: Asia/Shanghai
  ALIYUN_HOST: ${{ secrets.ALIYUN_HOST }}

jobs:
  # 检测变更的应用
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      admin-ele: ${{ steps.filter.outputs.admin-ele }}
      web-nuxt: ${{ steps.filter.outputs.web-nuxt }}
      shared: ${{ steps.filter.outputs.shared }}

    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            admin-ele:
              - 'apps/admin-ele/**'
            web-nuxt:
              - 'apps/web-nuxt/**'
            shared:
              - 'packages/**'
              - 'pnpm-lock.yaml'

  # 部署 admin-ele
  deploy-admin-ele:
    name: Deploy admin-ele
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      github.event_name == 'workflow_dispatch' && (github.event.inputs.deploy_target == 'all' || github.event.inputs.deploy_target == 'admin-ele') ||
      github.event_name == 'push' && (needs.detect-changes.outputs.admin-ele == 'true' || needs.detect-changes.outputs.shared == 'true')
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node

      - name: Build admin-ele
        run: pnpm run build:ele

      - name: Check admin-ele build output
        run: |
          if [ ! -d "apps/admin-ele/dist" ] || [ -z "$(ls -A apps/admin-ele/dist)" ]; then
            echo "Error: admin-ele build output directory is empty or does not exist."
            exit 1
          fi

      - name: Deploy to server
        if: ${{ env.ALIYUN_HOST != '' }}
        uses: easingthemes/ssh-deploy@v5.1.1
        with:
          SSH_PRIVATE_KEY: ${{ secrets.ALIYUN_SSH_KEY }}
          REMOTE_HOST: ${{ secrets.ALIYUN_HOST }}
          REMOTE_USER: ${{ secrets.ALIYUN_USER }}
          SOURCE: 'apps/admin-ele/dist/'
          TARGET: '/opt/xera/html/admin/'
          ARGS: '-avz --delete'

  # 部署 web-nuxt
  deploy-web-nuxt:
    name: Deploy web-nuxt
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      github.event_name == 'workflow_dispatch' && (github.event.inputs.deploy_target == 'all' || github.event.inputs.deploy_target == 'web-nuxt') ||
      github.event_name == 'push' && (needs.detect-changes.outputs.web-nuxt == 'true' || needs.detect-changes.outputs.shared == 'true')
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node

      - name: Build web-nuxt
        run: pnpm --filter @x-monorepo/web-nuxt generate

      - name: Check web-nuxt build output
        run: |
          if [ ! -d "apps/web-nuxt/.output/public" ] || [ -z "$(ls -A apps/web-nuxt/.output/public)" ]; then
            echo "Error: web-nuxt build output directory is empty or does not exist."
            exit 1
          fi

      - name: Deploy to server
        if: ${{ env.ALIYUN_HOST != '' }}
        uses: easingthemes/ssh-deploy@v5.1.1
        with:
          SSH_PRIVATE_KEY: ${{ secrets.ALIYUN_SSH_KEY }}
          REMOTE_HOST: ${{ secrets.ALIYUN_HOST }}
          REMOTE_USER: ${{ secrets.ALIYUN_USER }}
          SOURCE: 'apps/web-nuxt/.output/public/'
          TARGET: '/opt/xera/html/nuxt/'
          ARGS: '-avz --delete'
