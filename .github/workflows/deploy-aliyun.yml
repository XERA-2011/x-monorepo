name: Deploy to Aliyun

on:
  push:
    branches:
      - main
    paths:
      - 'apps/**'
      - 'packages/**'
      - 'pnpm-lock.yaml'
      - 'nginx.conf'
  workflow_dispatch:
    inputs:
      deploy_target:
        description: '选择部署目标'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - admin-ele
          - web-nuxt

env:
  CI: true
  TZ: Asia/Shanghai

jobs:
  # 检测变更的应用
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      admin-ele: ${{ steps.filter.outputs.admin-ele }}
      web-nuxt: ${{ steps.filter.outputs.web-nuxt }}
      shared: ${{ steps.filter.outputs.shared }}
      nginx: ${{ steps.filter.outputs.nginx }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            admin-ele:
              - 'apps/admin-ele/**'
            web-nuxt:
              - 'apps/web-nuxt/**'
            shared:
              - 'packages/**'
              - 'pnpm-lock.yaml'
            nginx:
              - 'nginx.conf'

  # 部署 admin-ele
  deploy-admin-ele:
    name: Deploy admin-ele
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      github.event_name == 'workflow_dispatch' && (github.event.inputs.deploy_target == 'all' || github.event.inputs.deploy_target == 'admin-ele') ||
      github.event_name == 'push' && (needs.detect-changes.outputs.admin-ele == 'true' || needs.detect-changes.outputs.shared == 'true')
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node

      - name: Build admin-ele
        run: pnpm run build:ele

      - name: Deploy to server
        uses: easingthemes/ssh-deploy@v5.1.1
        with:
          SSH_PRIVATE_KEY: ${{ secrets.ALIYUN_SSH_KEY }}
          REMOTE_HOST: ${{ secrets.ALIYUN_HOST }}
          REMOTE_USER: ${{ secrets.ALIYUN_USER }}
          SOURCE: 'apps/admin-ele/dist/'
          TARGET: '/opt/xera/html/admin/'
          ARGS: '-avz --delete'

  # 部署 web-nuxt
  deploy-web-nuxt:
    name: Deploy web-nuxt
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      github.event_name == 'workflow_dispatch' && (github.event.inputs.deploy_target == 'all' || github.event.inputs.deploy_target == 'web-nuxt') ||
      github.event_name == 'push' && (needs.detect-changes.outputs.web-nuxt == 'true' || needs.detect-changes.outputs.shared == 'true')
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node

      - name: Build web-nuxt
        run: pnpm --filter @x-monorepo/web-nuxt generate

      - name: Deploy to server
        uses: easingthemes/ssh-deploy@v5.1.1
        with:
          SSH_PRIVATE_KEY: ${{ secrets.ALIYUN_SSH_KEY }}
          REMOTE_HOST: ${{ secrets.ALIYUN_HOST }}
          REMOTE_USER: ${{ secrets.ALIYUN_USER }}
          SOURCE: 'apps/web-nuxt/.output/public/'
          TARGET: '/opt/xera/html/'
          ARGS: '-avz --delete --exclude admin'

  # 同步 nginx.conf
  deploy-nginx-conf:
    name: Deploy nginx.conf
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.nginx == 'true'
    steps:
      - uses: actions/checkout@v4
      - name: Deploy nginx.conf
        uses: easingthemes/ssh-deploy@v5.1.1
        with:
          SSH_PRIVATE_KEY: ${{ secrets.ALIYUN_SSH_KEY }}
          REMOTE_HOST: ${{ secrets.ALIYUN_HOST }}
          REMOTE_USER: ${{ secrets.ALIYUN_USER }}
          SOURCE: 'nginx.conf'
          TARGET: '/opt/xera/'
          ARGS: '-avz'

  # 重载 Nginx
  reload-nginx:
    name: Reload Nginx
    runs-on: ubuntu-latest
    needs: [deploy-admin-ele, deploy-web-nuxt, deploy-nginx-conf]
    if: always() && (needs.deploy-admin-ele.result == 'success' || needs.deploy-web-nuxt.result == 'success' || needs.deploy-nginx-conf.result == 'success')
    steps:
      - name: Reload Nginx
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.ALIYUN_HOST }}
          username: ${{ secrets.ALIYUN_USER }}
          key: ${{ secrets.ALIYUN_SSH_KEY }}
          script: |
            docker exec xera-nginx nginx -s reload || true
